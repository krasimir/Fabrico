<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html lang="en">
<head>

<script src="../utils/js/jquery-1.6.3.min.js"></script>
<script src="../utils/js/jquery.snippet.min.js"></script>
<script src="../utils/js/scripts.js" type="text/javascript" language="JavaScript"></script>
<link rel="stylesheet" type="text/css" href="../utils/css/jquery.snippet.min.css">


<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="generator" content="PHPDoctor 2RC4 (http://peej.github.com/phpdoctor/)">
<meta name="when" content="Mon, 02 Jan 2012 21:38:22 +0000">

<link rel="stylesheet" type="text/css" href="../stylesheet.css">
<link rel="start" href="../overview-summary.html">

<title>Fabrico\Fabrico.php (Fabrico)</title>

</head>
<body id="file" onload="parent.document.title=document.title;">

<div class="header">
<h1>Fabrico</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source\fabrico\fabrico.php.html" target="_top">No frames</a>
</div>
<hr>

<h1>Fabrico\Fabrico.php</h1>
<div class="comment" id="overview_description"><p>The root path of Fabrico's files.</p></div>

<hr>

<a name="line1"></a><pre><?php
<a name="line2"></a>
<a name="line3"></a>    /** The root path of Fabrico's files. */
<a name="line4"></a>    define("FABRICO_ROOT", dirname(__FILE__));
<a name="line5"></a>    /** If ?debug=1 an additional information is shown on the page. */
<a name="line6"></a>    define("DEBUG_MODE", isset($_GET["debug"]) && $_GET["debug"] == 1);
<a name="line7"></a>    
<a name="line8"></a>    require(FABRICO_ROOT."/modules/php/utils/Injector.php");
<a name="line9"></a>    /**
<a name="line10"></a>    * Instance of Injector class.
<a name="line11"></a>    * @see Injector
<a name="line12"></a>    */
<a name="line13"></a>    $fabricoInjector = new Injector();
<a name="line14"></a>    $fabricoInjector->setRoot(FABRICO_ROOT);
<a name="line15"></a>    
<a name="line16"></a>    /**
<a name="line17"></a>    * Global function for injecting files. Replacement of php's require.
<a name="line18"></a>    * @package Fabrico
<a name="line19"></a>    */
<a name="line20"></a>    function inject($args) {
<a name="line21"></a>        global $fabricoInjector;
<a name="line22"></a>        return $fabricoInjector->inject($args);
<a name="line23"></a>    }
<a name="line24"></a>    
<a name="line25"></a>    inject(array(
<a name="line26"></a>        "utils/ErrorHandler.php",
<a name="line27"></a>        "utils/view.php",
<a name="line28"></a>        "Middleware.php",
<a name="line29"></a>        "Request.php",
<a name="line30"></a>        "Response.php",
<a name="line31"></a>        "middleware/Router.php",
<a name="line32"></a>        "presenters/PresenterFactory.php"
<a name="line33"></a>    ));
<a name="line34"></a>    
<a name="line35"></a>    /**
<a name="line36"></a>    * Setup error handler callback.
<a name="line37"></a>    * @package Fabrico
<a name="line38"></a>    */
<a name="line39"></a>    $ERROR_HANDLER_CONTROLLER = "pages/Error.php";
<a name="line40"></a>    
<a name="line41"></a>    /**
<a name="line42"></a>    * Configure the views
<a name="line43"></a>    * @package Fabrico
<a name="line44"></a>    */
<a name="line45"></a>    ViewConfig::config(array(
<a name="line46"></a>        "root" => FABRICO_ROOT."/views/",
<a name="line47"></a>        "searchIn" => "Default"
<a name="line48"></a>    ));
<a name="line49"></a>    
<a name="line50"></a>    /**
<a name="line51"></a>     * Main class of Fabrico.
<a name="line52"></a>     * @package Fabrico
<a name="line53"></a>     */
<a name="line54"></a>    class Fabrico extends Middleware {
<a name="line55"></a>        
<a name="line56"></a>        public function __construct($configFile = "/config/config.json", $req = null, $res = null) {
<a name="line57"></a>        
<a name="line58"></a>            // setup middleware
<a name="line59"></a>            $this->using(array(
<a name="line60"></a>                // it stores the configurations and also setup redbean
<a name="line61"></a>                "benchmark" => "middleware/Benchmark.php",
<a name="line62"></a>                // it stores the configurations and also setup redbean
<a name="line63"></a>                "config" => "utils/JSONConfig.php",
<a name="line64"></a>                // read and construct the current application's models
<a name="line65"></a>                "models" => "middleware/ModelsManager.php",
<a name="line66"></a>                // $request->body will be parsed to object if incoming request is POST or PUT
<a name="line67"></a>                "bodyParser" => "middleware/BodyParser.php",
<a name="line68"></a>                // taking care for the assets
<a name="line69"></a>                "assets" => "middleware/AssetsManager.php",
<a name="line70"></a>                // control the access
<a name="line71"></a>                "access" => "middleware/Access.php",
<a name="line72"></a>                // setting the routes
<a name="line73"></a>                "routes" => "Routes.php",
<a name="line74"></a>                // router
<a name="line75"></a>                "router" => "middleware/Router.php"
<a name="line76"></a>            ));
<a name="line77"></a>            
<a name="line78"></a>            // Fabrico's configuration
<a name="line79"></a>            $this->config->source(array(
<a name="line80"></a>                "fabrico" => FABRICO_ROOT.$configFile
<a name="line81"></a>            ));
<a name="line82"></a>            
<a name="line83"></a>            // setting the Fabrico's credentials
<a name="line84"></a>            $this->access->setCredentials(
<a name="line85"></a>                $this->config->get("fabrico.access.user"), 
<a name="line86"></a>                $this->config->get("fabrico.access.pass")
<a name="line87"></a>            );
<a name="line88"></a>            
<a name="line89"></a>            // the ModelsManager uses the path to find the models' json files
<a name="line90"></a>            $this->models->root = FABRICO_ROOT;
<a name="line91"></a>            
<a name="line92"></a>            // assets configuration
<a name="line93"></a>            $this->assets->root = FABRICO_ROOT;
<a name="line94"></a>            $this->assets->using("Assets.php");
<a name="line95"></a>            
<a name="line96"></a>    
<a name="line97"></a>            $this->run($req, $res);
<a name="line98"></a>            
<a name="line99"></a>        }
<a name="line100"></a>        public function run($req, $res) {
<a name="line101"></a>        
<a name="line102"></a>            if($req == null) { $req = new Request(); }
<a name="line103"></a>            if($res == null) { $res = new Response(); }
<a name="line104"></a>            
<a name="line105"></a>            $this->root = (object) array(
<a name="line106"></a>                "http" => $req->host.($req->base == "/" ? "" : $req->base).$this->config->get("fabrico.paths.http"),
<a name="line107"></a>                "httpFiles" => $req->host.($req->base == "/" ? "" : $req->base).$this->config->get("fabrico.paths.files"),
<a name="line108"></a>                "files" => FABRICO_ROOT
<a name="line109"></a>            );
<a name="line110"></a>            
<a name="line111"></a>            // showing benchmark information if fabrico is in debug mode
<a name="line112"></a>            if(DEBUG_MODE) {
<a name="line113"></a>                ViewConfig::config(array("debug" => true));
<a name="line114"></a>                PresenterFactory::debug(true);
<a name="line115"></a>                $res->beforeExitHandler = array((object) array("obj" => $this, "method" => "onExit"));
<a name="line116"></a>                $this->router->debug = true;
<a name="line117"></a>            }
<a name="line118"></a>            
<a name="line119"></a>             // setting a pointer to the fabrico
<a name="line120"></a>            $req->fabrico = $this;
<a name="line121"></a>            
<a name="line122"></a>            // running middleware
<a name="line123"></a>            parent::run($req, $res);
<a name="line124"></a>            
<a name="line125"></a>        }
<a name="line126"></a>        
<a name="line127"></a>        /**
<a name="line128"></a>        * Called if ?debug=1. Displays information Benchmark and ModelsManager information.
<a name="line129"></a>        */
<a name="line130"></a>        public function onExit() {
<a name="line131"></a>            global $fabricoInjector;
<a name="line132"></a>            foreach($this->models->models as $model) {
<a name="line133"></a>                $model->report();
<a name="line134"></a>            }
<a name="line135"></a>            $fabricoInjector->report("#E9E9E9");
<a name="line136"></a>            $this->log("Benchmark: ".$this->benchmark->elpasedTime(), "#D5D5FF");
<a name="line137"></a>        }
<a name="line138"></a>        
<a name="line139"></a>        private function log($str, $color) {
<a name="line140"></a>            echo '<div class="debug" style="background:'.$color.'">'.$str.'</div>';
<a name="line141"></a>        }
<a name="line142"></a>    
<a name="line143"></a>    }
<a name="line144"></a>
<a name="line145"></a>?></pre>
<div class="header">
<h1>Fabrico</h1>
<ul>
<li><a href="../overview-summary.html">Overview</a></li>
<li>Package</li><li>Class</li><li>Tree</li><li><a href="../overview-files.html">Files</a></li>
<li><a href="../deprecated-list.html">Deprecated</a></li>
<li><a href="../todo-list.html">Todo</a></li>
<li><a href="../index-all.html">Index</a></li>
</ul>
</div>

<div class="small_links">
<a href="../index.html" target="_top">Frames</a>
<a href="../source\fabrico\fabrico.php.html" target="_top">No frames</a>
</div>
<hr>

<p id="footer">This document was generated by <a href="http://peej.github.com/phpdoctor/">PHPDoctor: The PHP Documentation Creator</a></p>

</body>

</html>